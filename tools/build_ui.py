#!/usr/bin/env python
#
# generate python files based on the designer ui files.
# pyuic4 and pyrcc4 should be on the path.
#

import os
import re
import sys
import subprocess

import os.path as p

# Change to pyside-uic.exe and pyside-rcc.exe for PySide
pyuicCommand = 'pyuic4'
pyrccCommand = 'pyrcc4'


def fileNewerThan(lfn, rfn):
    ''' Return True if lfn exists and rfn does not or lfn is newer than rfn
    '''
    return p.exists(lfn) and (not p.exists(rfn) or p.getmtime(lfn) > p.getmtime(rfn))

def main():

    if not p.isdir('designer'):
        sys.stderr.write('Please run this from the project root\n')
        sys.exit(1)
    
    if not p.isdir('aqt/forms'):
        os.mkdir('aqt/forms')
    
    initFn = 'aqt/forms/__init__.py'
    
    importLines = []
    with open(initFn, 'w') as initFp:
        
        initFp.write("# This file auto-generated by build_ui.py .. Don't edit.\n")
        initFp.write("__all__ = [\n")
        
        sys.stdout.write('Generating forms..\n')
        
        for uiFn in os.listdir('designer'):
            
            if not uiFn.endswith('.ui'):
                continue
            
            base = p.splitext(uiFn)[0]
            py = 'aqt/forms/{0}.py'.format(base)
            initFp.write('	"{0}",\n'.format(base))
            importLines.append('import {0}\n'.format(base))
            
            uiFn = p.join('designer', uiFn)
            if fileNewerThan(uiFn, py):
                sys.stdout.write(' * {0}\n'.format(py))
                subprocess.check_call([pyuicCommand, uiFn, '-o', py])
                # munge the output to use gettext
                with open(py, 'r+') as pyFp:
                    mungedOutput = re.sub(
                        r'QtGui.QApplication.translate\(\".*?\", (\".+?\"), None, QtGui\..+?\)', r'_(\1)', pyFp.read())
                    pyFp.seek(0)
                    pyFp.truncate()
                    pyFp.write(mungedOutput)
        
        initFp.write("]\n")
        initFp.writelines(importLines)
    
    sys.stdout.write('Building resources..\n')
    subprocess.check_call([pyrccCommand, 'designer/icons.qrc', '-o', 'aqt/forms/icons_rc.py'])

if __name__ == '__main__':
    main()

